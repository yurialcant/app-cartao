name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build Core Service
        run: |
          cd services/benefits-core
          mvn clean package -DskipTests
          
      - name: Test Core Service
        run: |
          cd services/benefits-core
          mvn test

  build-user-bff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build User BFF
        run: |
          cd services/user-bff
          mvn clean package -DskipTests
          
      - name: Test User BFF
        run: |
          cd services/user-bff
          mvn test

  build-admin-bff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build Admin BFF
        run: |
          cd services/admin-bff
          mvn clean package -DskipTests

  build-merchant-bff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build Merchant BFF
        run: |
          cd services/merchant-bff
          mvn clean package -DskipTests

  build-merchant-portal-bff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build Merchant Portal BFF
        run: |
          cd services/merchant-portal-bff
          mvn clean package -DskipTests

  docker-build:
    runs-on: ubuntu-latest
    needs: [build-core, build-user-bff, build-admin-bff, build-merchant-bff, build-merchant-portal-bff]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker images
        run: |
          docker build -t benefits-core:latest services/benefits-core
          docker build -t benefits-user-bff:latest services/user-bff
          docker build -t benefits-admin-bff:latest services/admin-bff
          docker build -t benefits-merchant-bff:latest services/merchant-bff
          docker build -t benefits-merchant-portal-bff:latest services/merchant-portal-bff
