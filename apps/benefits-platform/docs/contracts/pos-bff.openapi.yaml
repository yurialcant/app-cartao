openapi: 3.0.3
info:
  title: POS BFF API
  description: |
    Backend for Frontend (BFF) API for POS Terminal operations.
    
    **F06 - POS Payment Authorization**
    - Real-time payment authorization
    - Balance validation
    - Ledger entry creation
    - Statement update
    
    **Authorization:**
    - Requires JWT with `pos_terminal` role
    - Terminal ID must match JWT `terminal_id` claim
    - Merchant ID must match JWT `merchant_ids[]` claim
  version: 1.0.0
  contact:
    name: Benefits Platform Team

servers:
  - url: http://localhost:8084
    description: Local development server
  - url: https://api.benefits.example.com
    description: Production server

tags:
  - name: Payment Authorization
    description: F06 - POS payment authorization operations

paths:
  /api/v1/pos/test:
    get:
      summary: Health check endpoint
      tags:
        - Payment Authorization
      responses:
        '200':
          description: Service is running
          content:
            text/plain:
              schema:
                type: string
                example: "POS BFF is running!"

  /api/v1/pos/authorize:
    post:
      summary: Authorize POS payment (F06)
      description: |
        Authorize payment at POS terminal.
        
        **Features:**
        - Real-time balance validation
        - Atomic debit operation
        - Ledger entry creation
        - Statement update
        - Idempotent via idempotency_key
        
        **Flow:**
        1. Validate terminal and merchant
        2. Check wallet balance
        3. Debit wallet (atomic)
        4. Create ledger entry (DEBIT)
        5. Update statement
        6. Return authorization code
        
        **Response Codes:**
        - 200: APPROVED - Payment authorized
        - 400: DECLINED - Payment declined (insufficient funds, invalid terminal, etc.)
        - 500: SYSTEM_ERROR - Internal server error
      tags:
        - Payment Authorization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthorizeRequest'
            example:
              terminal_id: "TERM001"
              merchant_id: "MERCH001"
              person_id: "550e8400-e29b-41d4-a716-446655440001"
              wallet_id: "550e8400-e29b-41d4-a716-446655440200"
              amount: 150.75
              currency: "BRL"
              description: "Pagamento restaurante"
              idempotency_key: "auth-2026-01-18-001"
      parameters:
        - name: X-Tenant-Id
          in: header
          required: true
          description: Tenant ID (extracted from JWT if not provided)
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: X-Correlation-Id
          in: header
          required: false
          description: Correlation ID for distributed tracing
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthorizeResponse'
              example:
                authorization_code: "AUTH-20260118-001"
                status: "APPROVED"
                amount: 150.75
                balance_before: 1000.00
                balance_after: 849.25
                transaction_id: "550e8400-e29b-41d4-a716-446655440300"
                timestamp: "2026-01-18T10:30:00Z"
        '400':
          description: Payment declined
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthorizeResponse'
              example:
                status: "DECLINED"
                error_code: "INSUFFICIENT_FUNDS"
                error_message: "Insufficient balance in wallet"
                timestamp: "2026-01-18T10:30:00Z"
        '401':
          description: Unauthorized (missing or invalid JWT)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '403':
          description: Forbidden (terminal not authorized)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: System error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthorizeResponse'
              example:
                status: "DECLINED"
                error_code: "SYSTEM_ERROR"
                error_message: "Internal server error"
                timestamp: "2026-01-18T10:30:00Z"

  /api/v1/pos/confirm:
    post:
      summary: Confirm payment (placeholder)
      description: |
        Confirm payment at POS terminal.
        
        **Note:** This endpoint is currently a placeholder for future implementation.
      tags:
        - Payment Authorization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Payment confirmed (mock)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "confirmed"
                  payment_id:
                    type: string
                    example: "mock-123"

  /api/v1/pos/status:
    get:
      summary: Get terminal status (placeholder)
      description: |
        Get terminal status.
        
        **Note:** This endpoint is currently a placeholder for future implementation.
      tags:
        - Payment Authorization
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Terminal status
          content:
            application/json:
              schema:
                type: object

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token with `pos_terminal` role, `terminal_id` and `merchant_ids[]` claims

  schemas:
    AuthorizeRequest:
      type: object
      required:
        - terminal_id
        - merchant_id
        - person_id
        - wallet_id
        - amount
        - idempotency_key
      properties:
        terminal_id:
          type: string
          description: Terminal ID
          example: "TERM001"
        merchant_id:
          type: string
          description: Merchant ID
          example: "MERCH001"
        person_id:
          type: string
          format: uuid
          description: Person/User ID
          example: "550e8400-e29b-41d4-a716-446655440001"
        wallet_id:
          type: string
          format: uuid
          description: Wallet ID
          example: "550e8400-e29b-41d4-a716-446655440200"
        amount:
          type: number
          format: decimal
          minimum: 0.01
          description: Payment amount
          example: 150.75
        currency:
          type: string
          description: Currency code (default: BRL)
          default: "BRL"
          example: "BRL"
        description:
          type: string
          description: Payment description
          example: "Pagamento restaurante"
        idempotency_key:
          type: string
          description: Idempotency key for duplicate request prevention
          example: "auth-2026-01-18-001"

    AuthorizeResponse:
      type: object
      properties:
        authorization_code:
          type: string
          nullable: true
          description: Authorization code (if APPROVED)
          example: "AUTH-20260118-001"
        status:
          type: string
          enum: [APPROVED, DECLINED]
          description: Authorization status
          example: "APPROVED"
        amount:
          type: number
          format: decimal
          nullable: true
          description: Payment amount (if APPROVED)
          example: 150.75
        balance_before:
          type: number
          format: decimal
          nullable: true
          description: Wallet balance before transaction (if APPROVED)
          example: 1000.00
        balance_after:
          type: number
          format: decimal
          nullable: true
          description: Wallet balance after transaction (if APPROVED)
          example: 849.25
        transaction_id:
          type: string
          format: uuid
          nullable: true
          description: Transaction ID (if APPROVED)
          example: "550e8400-e29b-41d4-a716-446655440300"
        timestamp:
          type: string
          format: date-time
          description: Response timestamp
          example: "2026-01-18T10:30:00Z"
        error_code:
          type: string
          nullable: true
          description: Error code (if DECLINED)
          enum: [INSUFFICIENT_FUNDS, INVALID_TERMINAL, INVALID_MERCHANT, INVALID_WALLET, SYSTEM_ERROR]
          example: null
        error_message:
          type: string
          nullable: true
          description: Error message (if DECLINED)
          example: null

    ProblemDetails:
      type: object
      properties:
        type:
          type: string
          format: uri
          description: Problem type URI
          example: "https://api.benefits.example.com/problems/forbidden"
        title:
          type: string
          description: Problem title
          example: "Forbidden"
        status:
          type: integer
          description: HTTP status code
          example: 403
        detail:
          type: string
          description: Detailed error message
          example: "Terminal not authorized for this operation"
        instance:
          type: string
          format: uri
          description: Instance URI
          example: "/api/v1/pos/authorize"
        code:
          type: string
          description: Error code
          example: "FORBIDDEN_SCOPE"
        retryable:
          type: boolean
          description: Whether the request can be retried
          example: false
