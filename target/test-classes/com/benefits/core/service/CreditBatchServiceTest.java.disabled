package com.benefits.core.service;

import com.benefits.core.dto.CreditBatchRequest;
import com.benefits.core.dto.CreditBatchResponse;
import com.benefits.core.entity.CreditBatch;
import com.benefits.core.repository.CreditBatchRepository;
import com.benefits.core.repository.CreditBatchItemRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

import java.math.BigDecimal;
import java.util.List;
import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyIterable;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
public class CreditBatchServiceTest {

    @Mock
    private CreditBatchRepository creditBatchRepository;

    @Mock
    private CreditBatchItemRepository creditBatchItemRepository;

    @InjectMocks
    private CreditBatchService creditBatchService;

    @Test
    public void submitBatch_shouldCreateNewBatch() {
        // Given
        UUID tenantId = UUID.randomUUID();
        UUID employerId = UUID.randomUUID();
        UUID submittedByPid = UUID.randomUUID();
        String idempotencyKey = "test-key-123";

        CreditBatchRequest.CreditBatchItemRequest item = new CreditBatchRequest.CreditBatchItemRequest();
        item.setPersonId(UUID.randomUUID().toString());
        item.setWalletId(UUID.randomUUID().toString());
        item.setAmount(BigDecimal.valueOf(100.50));
        item.setDescription("Test credit");

        CreditBatchRequest request = new CreditBatchRequest();
        request.setBatchReference("Test Batch");
        request.setItems(List.of(item));

        CreditBatch savedBatch = new CreditBatch();
        savedBatch.setId(UUID.randomUUID()); // Use UUID for database ID
        savedBatch.setTenantId(tenantId);
        savedBatch.setEmployerId(employerId);
        savedBatch.setIdempotencyKey(idempotencyKey);
        savedBatch.setTotalItems(1);
        savedBatch.setStatus("SUBMITTED");

        when(creditBatchRepository.findByTenantIdAndIdempotencyKey(tenantId, idempotencyKey))
            .thenReturn(Mono.empty());
        when(creditBatchRepository.save(any(CreditBatch.class)))
            .thenReturn(Mono.just(savedBatch));
        when(creditBatchItemRepository.saveAll(anyIterable()))
            .thenReturn(Flux.empty());
        when(creditBatchItemRepository.findByBatchId(any(Long.class))) // Use Long for batchId in items
            .thenReturn(Flux.empty());

        // When
        Mono<CreditBatchResponse> result = creditBatchService.submitBatch(tenantId, employerId, request, idempotencyKey, submittedByPid);

        // Then
        StepVerifier.create(result)
            .expectNextMatches(response -> response.getId() != null && "SUBMITTED".equals(response.getStatus()))
            .verifyComplete();
    }

    @Test
    public void submitBatch_shouldReturnExistingBatchForIdempotency() {
        // Given
        UUID tenantId = UUID.randomUUID();
        UUID employerId = UUID.randomUUID();
        UUID submittedByPid = UUID.randomUUID();
        String idempotencyKey = "test-key-123";

        CreditBatchRequest.CreditBatchItemRequest item = new CreditBatchRequest.CreditBatchItemRequest();
        item.setPersonId(UUID.randomUUID().toString());
        item.setWalletId(UUID.randomUUID().toString());
        item.setAmount(BigDecimal.valueOf(100.50));
        item.setDescription("Test credit");

        CreditBatchRequest request = new CreditBatchRequest();
        request.setBatchReference("Test Batch");
        request.setItems(List.of(item));

        UUID existingBatchId = UUID.randomUUID();
        CreditBatch existingBatch = new CreditBatch();
        existingBatch.setId(existingBatchId); // Use UUID for database ID
        existingBatch.setTenantId(tenantId);
        existingBatch.setEmployerId(employerId);
        existingBatch.setBatchName("Test Batch");
        existingBatch.setTotalAmountCents(10050L);
        existingBatch.setTotalItems(1);
        existingBatch.setStatus("SUBMITTED");

        when(creditBatchRepository.findByTenantIdAndIdempotencyKey(tenantId, idempotencyKey))
            .thenReturn(Mono.just(existingBatch));
        when(creditBatchItemRepository.findByBatchId(any(UUID.class))) // Use UUID for batchId in items
            .thenReturn(Flux.empty());

        // When
        Mono<CreditBatchResponse> result = creditBatchService.submitBatch(tenantId, employerId, request, idempotencyKey, submittedByPid);

        // Then
        StepVerifier.create(result)
            .expectNextMatches(response -> response.getId().equals(existingBatch.getId().toString()))
            .verifyComplete();
    }
}